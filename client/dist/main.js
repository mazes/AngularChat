"use strict";angular.module("angularChat",["ui.bootstrap","ngRoute","ngAnimate","ui-notification","hSweetAlert"]).value("loggedIn",{logged:!1}).config(["$routeProvider","$locationProvider",function(e,o){o.html5Mode(!0),e.when("/",{templateUrl:"components/login/login.html",controller:"LoginController"}).when("/roomlist",{templateUrl:"components/roomlist/roomlist.html",controller:"RoomListController"}).when("/createroom",{templateUrl:"components/createroom/createroom.html",controller:"CreateRoomController"}).when("/chat/:room",{templateUrl:"components/chat/chat.html",controller:"ChatController"}).when("/chat/private/:chattee",{templateUrl:"components/privatechat/privateChat.html",controller:"PrivateChatController"}).when("/unreadpms/",{templateUrl:"components/inbox/inbox.html",controller:"InboxController"}).otherwise("/",{templateUrl:"components/login/login.html",controller:"LoginController"})}]).directive("autofocus",["$timeout",function(e){return{restrict:"A",link:function(o,r){e(function(){r[0].focus()})}}}]),angular.module("angularChat").controller("ChatController",["$scope","$routeParams","$location","ChatResource","$route","socket","$timeout","Notification","loggedIn",function(e,o,r,t,n,s,a,i,c){c.logged||r.url("/"),e.unReadMessages=t.getNumberOfUnreadMessages(),e.roomName=o.room,e.currentUser=t.getUser(),e.commands=["Send Message","Kick","Ban","Op","DeOp"],e.actionBar=!0,e.isServerMsg=!0,e.userAction={room:e.roomName,user:void 0,operator:e.currentUser},e.serverMessages=[],e.isOp=!1,e.setTopic=!1,e.getMessages=function(){e.chat=e.currentRoom.messageHistory,e.users=e.currentRoom.users,e.ops=e.currentRoom.ops,e.topic=e.currentRoom.topic,e.bannedUsers=e.currentRoom.banned;for(var o in e.ops)e.currentUser===o&&(e.isOp=!0)},e.init=function(){t.getRoomList()},s.on("roomlist",function(r){for(var t in r)t===o.room&&(e.currentRoom=r[t],e.getMessages())}),s.on("recv_privatemsg",function(o,r){t.addpMessage(r,o,e.currentUser),e.newmessage=t.getNewestPmessage(),e.newmessage.receiver===e.currentUser&&i.primary({message:"You've received a private message from "+e.newmessage.sender,templateUrl:"chat/notify.html",scope:e,delay:7e3})}),s.on("updatechat",function(r,t){r===o.room&&(e.chat=t)}),s.on("updateusers",function(e,o,r){t.getRoomList()}),s.on("updatetopic",function(r,t,n){r===o.room&&(e.topic=t,e.sendServerMessage(n+" set new topic for the room!"))}),s.on("servermessage",function(r,t,n){if(t===o.room){var s="";switch(r){case"join":s=n+" has joined the room!";break;case"part":s=n+" has left the room!";break;case"quit":s=n+"has disconnected from server!"}e.sendServerMessage(s)}}),s.on("kicked",function(o,r,t){var n=t+" kicked "+r+" from the room!";e.sendServerMessage(n)}),s.on("banned",function(n,s,a){if(n===o.room){if(s===e.currentUser)return void r.url("/roomlist");t.getRoomList();var i=a+" banned "+s+" from the room!";e.sendServerMessage(i)}}),s.on("opped",function(r,t,n){r===o.room&&e.sendServerMessage(n+" gave  "+t+" op rights!")}),s.on("deopped",function(r,t,n){r===o.room&&e.sendServerMessage(n+" stripped  "+t+" op rights!")}),e.leaveChat=function(){t.leaveChat(e.roomName),r.url("/roomlist")},e.sendMessage=function(){var o={roomName:e.roomName,msg:e.message};t.sendMessage(o),e.message=""},e.operations=function(o){e.userAction.user=o,e.actionBar=!1},e.unBan=function(r){e.userAction.user=r,t.unBanUser(e.userAction,function(n){if(n){e.sendServerMessage("You un-banned user from room!"),t.getRoomList();var s={nick:r,message:"I have un-banned you from room: "+o.room};t.sendPrivateMessage(s,function(o){o&&e.sendServerMessage("You have notified user that he is free to join the room")})}else e.sendServerMessage("You need op rights for this operation!")})},e.actionBarCommand=function(o){switch(o){case"Send Message":r.url("/chat/private/"+e.userAction.user);break;case"Kick":t.kickUser(e.userAction,function(o){o||e.sendServerMessage("You need op rights for this operation!")});break;case"Ban":t.banUser(e.userAction,function(o){o||e.sendServerMessage("You need op rights for this operation!")});break;case"Op":t.giveOP(e.userAction,function(o){o||e.sendServerMessage("You need op rights for this operation!")});break;case"DeOp":t.deOP(e.userAction,function(o){o||e.sendServerMessage("You need op rights for this operation!")});break;default:e.sendServerMessage("For some reason request failed!")}e.actionBar=!0},e.gotoPm=function(e){r.url("/chat/private/"+e.sender)},e.sendServerMessage=function(o){e.serverMessages.push(o),a(function(){e.serverMessages.shift()},5e3)},e.topicTrue=function(){e.setTopic=!0},e.passwordTrue=function(){e.setPassword=!0},e.editTopic=function(){var r={room:o.room,topic:e.newTopic};t.setTopic(r,function(e){}),e.newTopic="",e.addTopic.$setPristine(),e.setTopic=!1},e.editPassword=function(){var r={room:o.room,pass:e.newPassword};t.setPassword(r,function(r){if(r)for(var n in e.ops)if(n!==e.currentUser){var s={nick:n,message:"I changed the password in "+o.room+" to: "+e.newPassword};t.sendPrivateMessage(s,function(o){o&&e.sendServerMessage("You have sent the new password to other ops!")})}}),e.newPassword="",e.setPass.$setPristine(),e.setPassword=!1},e.removePassword=function(){var r={room:o.room};t.removePassword(r,function(r){if(r)for(var n in e.ops)if(n!==e.currentUser){var s={nick:n,message:"I removed the password in "+o.room};t.sendPrivateMessage(s,function(o){o&&e.sendServerMessage("You have sent the new password to other ops!")})}})},e.$on("$destroy",function(){s.off("recv_privatemsg",function(e){})})}]),angular.module("angularChat").controller("CreateRoomController",["$scope","$routeParams","$location","ChatResource","socket","loggedIn",function(e,o,r,t,n,s){s.logged||r.url("/"),e.unReadMessages=t.getNumberOfUnreadMessages(),e.currentUser=t.getUser(),e.pass=void 0,n.on("recv_privatemsg",function(o,r){t.addpMessage(r,o,e.currentUser),e.newmessage=t.getNewestPmessage(),e.newmessage.receiver===e.currentUser&&Notification.primary({message:"You've received a private message from "+e.newmessage.sender,templateUrl:"chat/notify.html",scope:e,delay:7e3})}),e.createRoom=function(){e.currentUser=o.username,e.room={room:e.name,pass:e.pass,topic:e.topic},t.joinRoom(e.room,function(o,n){if(o){r.url("/chat/"+e.name);var s={room:e.name,topic:e.topic};t.setTopic(s,function(e){})}else console.log(n)})},e.$on("$destroy",function(){n.off("recv_privatemsg",function(e){e?console.log("destroy"):console.log("failed destroy")})})}]),angular.module("angularChat").controller("LoginController",["$scope","$location","ChatResource","$routeParams","loggedIn",function(e,o,r,t,n){e.pass="",e.errorMessage="",e.onLogin=function(){r.login(e.currentUser,e.pass,function(t){t?(r.setUser(e.currentUser),n.logged=!0,o.url("/roomlist")):(e.errorMessage="Username is taken!",e.inputForm.$setPristine())})}}]),angular.module("angularChat").controller("InboxController",["$scope","$routeParams","$http","$location","ChatResource","socket",function(e,o,r,t,n,s){e.currentUser=n.getUser(),e.unReadMessages=n.getNumberOfUnreadMessages(),e.getUnread=function(){for(var e=n.getpMessages(),o=[],r=0;r<e.length;r++)e[r].read||o.push(e[r]);return o},e.gotoPm=function(e){t.url("/chat/private/"+e)},e.messages=e.getUnread()}]),angular.module("angularChat").controller("PrivateChatController",["$scope","$routeParams","$location","ChatResource","$route","socket","loggedIn",function(e,o,r,t,n,s,a){a.logged||r.url("/"),e.chattee=o.chattee,e.currentUser=t.getUser(),s.on("recv_privatemsg",function(o,r){console.log("Receiving message"),t.addpMessage(r,o,e.currentUser),e.chat=e.getMessages()}),e.sendPrivateMessage=function(o){console.log("Inside send pm with user:"+o+" currentuser: "+e.currentUser),e.privateMessage={nick:o,message:e.message},t.sendPrivateMessage(e.privateMessage,function(r){r?(t.addpMessage(e.message,e.currentUser,o),e.chat=e.getMessages()):console.log("did not work")})},e.getMessages=function(){for(var o=t.getpMessages(),r=[],n=0;n<o.length;n++)(e.currUserChattee(o[n])||e.chatteeCurrUser(o[n]))&&(o[n].read=!0,r.push(o[n]));return r},e.currUserChattee=function(r){return r.sender===e.currentUser&&r.receiver===o.chattee},e.chatteeCurrUser=function(r){return r.sender===o.chattee&&r.receiver===e.currentUser},e.goToChat=function(e){r.url("/chat/private/"+e)},e.getUsers=function(){t.getUsers(),s.on("userlist",function(o){e.users=o})},e.$on("$destroy",function(){s.off("recv_privatemsg",function(e){e?console.log("destroy"):console.log("failed destroy")})}),e.chat=e.getMessages()}]),angular.module("angularChat").factory("ChatResource",["socket",function(e){var o={},r=[];return{login:function(o,r,t){e.emit("adduser",o,t)},getRoomList:function(){e.emit("rooms")},getUsers:function(){e.emit("users")},joinRoom:function(o,r){e.emit("joinroom",o,r)},setTopic:function(o,r){e.emit("settopic",o,r)},sendMessage:function(o){e.emit("sendmsg",o)},sendPrivateMessage:function(o,r){e.emit("privatemsg",o,r)},leaveChat:function(o){e.emit("partroom",o)},kickUser:function(o,r){e.emit("kick",o,r)},banUser:function(o,r){e.emit("ban",o,r)},unBanUser:function(o,r){e.emit("unban",o,r)},giveOP:function(o,r){e.emit("op",o,r)},deOP:function(o,r){e.emit("deop",o,r)},disconnect:function(){e.disconnect()},setPassword:function(o,r){e.emit("setpassword",o,r)},removePassword:function(o,r){e.emit("removepassword",o,r)},getUser:function(){return o},setUser:function(e){o=e},addpMessage:function(e,o,t){var n=new Date,s={receiver:t,sender:o,message:e,date:n,read:!1};r.push(s)},getpMessages:function(){return r},getNewestPmessage:function(){return r[r.length-1]},getNumberOfUnreadMessages:function(){for(var e=0,o=0;o<r.length;o++)r[o].read||(e+=1);return e}}}]),angular.module("angularChat").factory("socket",function(e){var o=io.connect("http://localhost:8080");return{on:function(r,t){o.on(r,function(){var r=arguments;e.$apply(function(){t.apply(o,r)})})},emit:function(r,t,n){o.emit(r,t,function(){var r=arguments;e.$apply(function(){n&&n.apply(o,r)})})},off:function(r,t){o.removeAllListeners(r,function(){var r=arguments;e.$apply(function(){t&&t.apply(o,r)})})},disconnect:function(){o.disconnect()}}}),angular.module("angularChat").controller("RoomListController",["$scope","$routeParams","$location","ChatResource","socket","sweet","Notification","loggedIn",function(e,o,r,t,n,s,a,i){i.logged||r.url("/"),e.unReadMessages=t.getNumberOfUnreadMessages(),e.currentUser=t.getUser(),e.currentPassword="",e.userList=function(){t.getUsers(),n.on("userlist",function(o){e.users=o})},n.on("roomlist",function(o){e.rooms=o}),n.on("recv_privatemsg",function(o,r){t.addpMessage(r,o,e.currentUser),e.newmessage=t.getNewestPmessage(),e.newmessage.receiver===e.currentUser&&a.primary({message:"You've received a private message from "+e.newmessage.sender,templateUrl:"chat/notify.html",scope:e,delay:7e3})}),e.getRooms=function(){t.getRoomList()},e.joinRoom=function(o,n){for(var a in n.users)if(a===e.currentUser)return void r.url("/chat/"+o);for(var i in n.ops)if(i===e.currentUser)return void r.url("/chat/"+o);if(n.locked)s.show({title:"This room is password protected",text:"Please enter the password",type:"input",showCancelButton:!0,closeOnConfirm:!0,animation:"slide-from-top",inputPlaceholder:"Write something"},function(r){e.currentPassword=r,e.checkIfValid(r,o)});else{var c={room:o,pass:void 0};t.joinRoom(c,function(e,t){e?r.url("/chat/"+o):console.log(t)})}},e.checkIfValid=function(e,o){var n={room:o,pass:e};t.joinRoom(n,function(e,t){e?r.url("/chat/"+o):a.error({title:"Could not enter room",message:"Reason: "+t,positionY:"top",positionX:"right"})})},e.sendPrivate=function(e){r.url("/chat/private/"+e)},e.$on("$destroy",function(){n.off("recv_privatemsg",function(e){e?console.log("destroy"):console.log("failed destroy")})})}]);