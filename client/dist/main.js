"use strict";angular.module("angularChat",["ui.bootstrap","ngRoute","ngAnimate","ui-notification","hSweetAlert","angular.filter"]).value("loggedIn",{logged:!1}).config(["$routeProvider","$locationProvider",function(e,o){e.when("/",{templateUrl:"app/components/login/login.html",controller:"LoginController"}).when("/roomlist",{templateUrl:"app/components/roomlist/roomlist.html",controller:"RoomListController"}).when("/createroom",{templateUrl:"app/components/createroom/createroom.html",controller:"CreateRoomController"}).when("/chat/:room",{templateUrl:"app/components/chat/chat.html",controller:"ChatController"}).when("/chat/private/:chattee",{templateUrl:"app/components/privatechat/privateChat.html",controller:"PrivateChatController"}).when("/unreadpms/",{templateUrl:"app/components/inbox/inbox.html",controller:"InboxController"}).otherwise({redirectTo:""}),o.html5Mode({enabled:!0,requireBase:!0})}]).directive("autofocus",["$timeout",function(e){return{restrict:"A",link:function(o,r){e(function(){r[0].focus()})}}}]),angular.module("angularChat").factory("socket",["$rootScope",function(e){var o=io.connect("http://localhost:8080");return{on:function(r,t){o.on(r,function(){var r=arguments;e.$apply(function(){t.apply(o,r)})})},emit:function(r,t,s){o.emit(r,t,function(){var r=arguments;e.$apply(function(){s&&s.apply(o,r)})})},off:function(r,t){o.removeAllListeners(r,function(){var r=arguments;e.$apply(function(){t&&t.apply(o,r)})})},disconnect:function(){o.disconnect()}}}]),angular.module("angularChat").controller("ChatController",["$scope","$routeParams","$location","ChatResource","$route","socket","$timeout","Notification","loggedIn",function(e,o,r,t,s,n,a,i,c){c.logged||r.url("/"),e.unReadMessages=t.getNumberOfUnreadMessages(),e.roomName=o.room,e.currentUser=t.getUser(),e.commands=["Send Message","Kick","Ban","Op","DeOp"],e.actionBar=!0,e.isServerMsg=!0,e.userAction={room:e.roomName,user:void 0,operator:e.currentUser},e.serverMessages=[],e.isOp=!1,e.setTopic=!1,e.getMessages=function(){e.chat=e.currentRoom.messageHistory,e.users=e.currentRoom.users,e.ops=e.currentRoom.ops,e.topic=e.currentRoom.topic,e.bannedUsers=e.currentRoom.banned;for(var o in e.ops)e.currentUser===o&&(e.isOp=!0)},e.init=function(){t.getRoomList()},n.on("roomlist",function(r){for(var t in r)t===o.room&&(e.currentRoom=r[t],e.getMessages())}),n.on("recv_privatemsg",function(o,r){t.addpMessage(r,o,e.currentUser),e.newmessage=t.getNewestPmessage(),e.newmessage.receiver===e.currentUser&&i.primary({message:"You've received a private message from "+e.newmessage.sender,templateUrl:"app/components/chat/notify.html",scope:e,delay:7e3}),e.unReadMessages=t.getNumberOfUnreadMessages()}),n.on("updatechat",function(r,t){r===o.room&&(e.chat=t)}),n.on("updateusers",function(e,o,r){t.getRoomList()}),n.on("updatetopic",function(r,t,s){r===o.room&&(e.topic=t,e.sendServerMessage(s+" set new topic for the room!"))}),n.on("servermessage",function(r,t,s){if(t===o.room){var n="";switch(r){case"join":n=s+" has joined the room!";break;case"part":n=s+" has left the room!";break;case"quit":n=s+"has disconnected from server!"}e.sendServerMessage(n)}}),n.on("kicked",function(o,r,t){var s=t+" kicked "+r+" from the room!";e.sendServerMessage(s)}),n.on("banned",function(s,n,a){if(s===o.room){if(n===e.currentUser)return void r.url("/roomlist");t.getRoomList();var i=a+" banned "+n+" from the room!";e.sendServerMessage(i)}}),n.on("opped",function(r,t,s){r===o.room&&e.sendServerMessage(s+" gave  "+t+" op rights!")}),n.on("deopped",function(r,t,s){r===o.room&&e.sendServerMessage(s+" stripped  "+t+" op rights!")}),e.leaveChat=function(){t.leaveChat(e.roomName),r.url("/roomlist")},e.sendMessage=function(){var o={roomName:e.roomName,msg:e.message};t.sendMessage(o),e.message=""},e.operations=function(o){e.userAction.user=o,e.actionBar=!1},e.unBan=function(r){e.userAction.user=r,t.unBanUser(e.userAction,function(s){if(s){e.sendServerMessage("You un-banned user from room!"),t.getRoomList();var n={nick:r,message:"I have un-banned you from room: "+o.room};t.sendPrivateMessage(n,function(o){o&&e.sendServerMessage("You have notified user that he is free to join the room")})}else e.sendServerMessage("You need op rights for this operation!")})},e.actionBarCommand=function(o){switch(o){case"Send Message":r.url("/chat/private/"+e.userAction.user);break;case"Kick":t.kickUser(e.userAction,function(o){o||e.sendServerMessage("You need op rights for this operation!")});break;case"Ban":t.banUser(e.userAction,function(o){o||e.sendServerMessage("You need op rights for this operation!")});break;case"Op":t.giveOP(e.userAction,function(o){o||e.sendServerMessage("You need op rights for this operation!")});break;case"DeOp":t.deOP(e.userAction,function(o){o||e.sendServerMessage("You need op rights for this operation!")});break;default:e.sendServerMessage("For some reason request failed!")}e.actionBar=!0},e.gotoPm=function(e){r.url("/chat/private/"+e)},e.sendServerMessage=function(o){e.serverMessages.push(o),a(function(){e.serverMessages.shift()},5e3)},e.topicTrue=function(){e.setTopic=!0},e.passwordTrue=function(){e.setPassword=!0},e.editTopic=function(){var r={room:o.room,topic:e.newTopic};t.setTopic(r,function(e){}),e.newTopic="",e.addTopic.$setPristine(),e.setTopic=!1},e.editPassword=function(){var r={room:o.room,pass:e.newPassword};t.setPassword(r,function(s){if(s)for(var n in e.ops)if(n!==e.currentUser){var a={nick:n,message:"I changed the password in "+o.room+" to: "+r.pass};t.sendPrivateMessage(a,function(o){o&&e.sendServerMessage("You have sent the new password to other ops!")})}}),e.newPassword="",e.setPass.$setPristine(),e.setPassword=!1},e.removePassword=function(){var r={room:o.room};t.removePassword(r,function(r){if(r)for(var s in e.ops)if(s!==e.currentUser){var n={nick:s,message:"I removed the password in "+o.room};t.sendPrivateMessage(n,function(o){o&&e.sendServerMessage("You have sent the new password to other ops!")})}})},e.$on("$destroy",function(){n.off("recv_privatemsg",function(e){})})}]),angular.module("angularChat").controller("CreateRoomController",["$scope","$routeParams","$location","ChatResource","socket","loggedIn","Notification",function(e,o,r,t,s,n,a){n.logged||r.url("/"),e.unReadMessages=t.getNumberOfUnreadMessages(),e.currentUser=t.getUser(),e.pass=void 0,s.on("recv_privatemsg",function(o,r){t.addpMessage(r,o,e.currentUser),e.newmessage=t.getNewestPmessage(),e.newmessage.receiver===e.currentUser&&(a.primary({message:"You've received a private message from "+e.newmessage.sender,templateUrl:"app/components/chat/notify.html",scope:e,delay:7e3}),e.unReadMessages=t.getNumberOfUnreadMessages())}),e.createRoom=function(){e.currentUser=o.username,e.room={room:e.name,pass:e.pass,topic:e.topic},t.joinRoom(e.room,function(o,s){if(o){r.url("/chat/"+e.name);var n={room:e.name,topic:e.topic};t.setTopic(n,function(e){})}else console.log(s)})},e.gotoPm=function(e){r.url("/chat/private/"+e)},e.$on("$destroy",function(){s.off("recv_privatemsg",function(e){})})}]),angular.module("angularChat").controller("InboxController",["$scope","$routeParams","$http","$location","ChatResource","socket","Notification",function(e,o,r,t,s,n,a){e.currentUser=s.getUser(),e.unReadMessages=s.getNumberOfUnreadMessages(),n.on("recv_privatemsg",function(o,r){s.addpMessage(r,o,e.currentUser),e.newmessage=s.getNewestPmessage(),e.newmessage.receiver===e.currentUser&&(a.primary({message:"You've received a private message from "+e.newmessage.sender,templateUrl:"app/components/chat/notify.html",scope:e,delay:7e3}),e.unReadMessages=s.getNumberOfUnreadMessages(),e.messages=e.getUnread())}),e.getUnread=function(){for(var e=s.getpMessages(),o=[],r=0;r<e.length;r++)e[r].read||o.push(e[r]);return o},e.gotoPm=function(e){t.url("/chat/private/"+e)},e.messages=e.getUnread(),e.$on("$destroy",function(){n.off("recv_privatemsg",function(e){})})}]),angular.module("angularChat").controller("LoginController",["$scope","$location","ChatResource","$routeParams","loggedIn",function(e,o,r,t,s){e.pass="",e.errorMessage="",e.onLogin=function(){r.login(e.currentUser,e.pass,function(t){t?(r.setUser(e.currentUser),s.logged=!0,o.url("/roomlist")):(e.errorMessage="Username is taken!",e.inputForm.$setPristine())})}}]),angular.module("angularChat").controller("PrivateChatController",["$scope","$routeParams","$location","ChatResource","$route","socket","loggedIn","Notification",function(e,o,r,t,s,n,a,i){a.logged||r.url("/"),e.chattee=o.chattee,e.currentUser=t.getUser(),e.unReadMessages=t.getNumberOfUnreadMessages(),n.on("recv_privatemsg",function(o,r){t.addpMessage(r,o,e.currentUser),e.chat=e.getMessages(),e.newmessage=t.getNewestPmessage(),e.newmessage.sender!=e.chattee&&i.primary({message:"You've received a private message from "+e.newmessage.sender,templateUrl:"app/components/chat/notify.html",scope:e,delay:7e3})}),e.sendPrivateMessage=function(o){e.privateMessage={nick:o,message:e.message},t.sendPrivateMessage(e.privateMessage,function(r){r?(t.addpMessage(e.message,e.currentUser,o),e.chat=e.getMessages(),e.message=""):console.log("did not work")})},e.getMessages=function(){for(var o=t.getpMessages(),r=[],s=0;s<o.length;s++)(e.currUserChattee(o[s])||e.chatteeCurrUser(o[s]))&&(o[s].read=!0,r.push(o[s])),e.unReadMessages=t.getNumberOfUnreadMessages();return r},e.currUserChattee=function(r){return r.sender===e.currentUser&&r.receiver===o.chattee},e.chatteeCurrUser=function(r){return r.sender===o.chattee&&r.receiver===e.currentUser},e.goToChat=function(e){r.url("/chat/private/"+e)},e.getUsers=function(){t.getUsers(),n.on("userlist",function(o){e.users=o})},e.leavePrivate=function(){var e=t.getCurrentRoom();""===e?r.url("/roomlist"):r.url("/chat/"+e)},e.gotoPm=function(e){r.url("/chat/private/"+e)},e.$on("$destroy",function(){n.off("recv_privatemsg",function(e){})}),e.chat=e.getMessages()}]),angular.module("angularChat").factory("ChatResource",["socket",function(e){var o={},r=[],t="";return{login:function(o,r,t){e.emit("adduser",o,t)},getRoomList:function(){e.emit("rooms")},getUsers:function(){e.emit("users")},joinRoom:function(o,r){e.emit("joinroom",o,r)},setTopic:function(o,r){e.emit("settopic",o,r)},sendMessage:function(o){e.emit("sendmsg",o)},sendPrivateMessage:function(o,r){e.emit("privatemsg",o,r)},leaveChat:function(o){e.emit("partroom",o)},kickUser:function(o,r){e.emit("kick",o,r)},banUser:function(o,r){e.emit("ban",o,r)},unBanUser:function(o,r){e.emit("unban",o,r)},giveOP:function(o,r){e.emit("op",o,r)},deOP:function(o,r){e.emit("deop",o,r)},disconnect:function(){e.disconnect()},setPassword:function(o,r){e.emit("setpassword",o,r)},removePassword:function(o,r){e.emit("removepassword",o,r)},getUser:function(){return o},setUser:function(e){o=e},addpMessage:function(e,o,t){var s=new Date,n={receiver:t,sender:o,message:e,date:s,read:!1};r.push(n)},getpMessages:function(){return r},getNewestPmessage:function(){return r[r.length-1]},getNumberOfUnreadMessages:function(){for(var e=0,o=0;o<r.length;o++)r[o].read||(e+=1);return e},setCurrentRoom:function(e){t=e},getCurrentRoom:function(){return t}}}]),angular.module("angularChat").controller("RoomListController",["$scope","$routeParams","$location","ChatResource","socket","sweet","Notification","loggedIn",function(e,o,r,t,s,n,a,i){i.logged||r.url("/"),e.unReadMessages=t.getNumberOfUnreadMessages(),e.currentUser=t.getUser(),e.currentPassword="",e.userList=function(){t.getUsers(),s.on("userlist",function(o){e.users=o})},s.on("roomlist",function(o){e.rooms=o}),s.on("recv_privatemsg",function(o,r){t.addpMessage(r,o,e.currentUser),e.newmessage=t.getNewestPmessage(),e.newmessage.receiver===e.currentUser&&(a.primary({message:"You've received a private message from "+e.newmessage.sender,templateUrl:"app/components/chat/notify.html",scope:e,delay:7e3}),e.unReadMessages=t.getNumberOfUnreadMessages())}),e.getRooms=function(){t.getRoomList()},e.joinRoom=function(o,s){for(var a in s.users)if(a===e.currentUser)return void r.url("/chat/"+o);for(var i in s.ops)if(i===e.currentUser)return void r.url("/chat/"+o);if(s.locked)n.show({title:"This room is password protected",text:"Please enter the password",type:"input",showCancelButton:!0,closeOnConfirm:!0,animation:"slide-from-top",inputPlaceholder:"Write something"},function(r){e.currentPassword=r,e.checkIfValid(r,o)});else{var c={room:o,pass:void 0};t.joinRoom(c,function(e,s){e?(t.setCurrentRoom(o),r.url("/chat/"+o)):console.log(s)})}},e.checkIfValid=function(e,o){var s={room:o,pass:e};t.joinRoom(s,function(e,t){e?r.url("/chat/"+o):a.error({title:"Could not enter room",message:"Reason: "+t,positionY:"top",positionX:"right"})})},e.gotoPm=function(e){r.url("/chat/private/"+e)},e.sendPrivate=function(e){r.url("/chat/private/"+e)},e.$on("$destroy",function(){s.off("recv_privatemsg",function(e){})})}]);